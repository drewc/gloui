(function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],t):t(CodeMirror)})((function(t){"use strict";var e,r,n,o,i={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},s=t.Pos,a=t.cmpPos;function l(t){return"[object Array]"==Object.prototype.toString.call(t)}function u(e){var r=e.doc.modeOption;return"sql"===r&&(r="text/x-sql"),t.resolveMode(r).keywords}function f(e){var r=e.doc.modeOption;return"sql"===r&&(r="text/x-sql"),t.resolveMode(r).identifierQuote||"`"}function c(t){return"string"==typeof t?t:t.text}function p(t,e){return l(e)&&(e={columns:e}),e.text||(e.text=t),e}function d(t){var e={};if(l(t))for(var r=t.length-1;r>=0;r--){var n=t[r];e[c(n).toUpperCase()]=p(c(n),n)}else if(t)for(var o in t)e[o.toUpperCase()]=p(o,t[o]);return e}function g(t){return e[t.toUpperCase()]}function h(t){var e={};for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}function v(t,e){var r=t.length,n=c(e).substr(0,r);return t.toUpperCase()===n.toUpperCase()}function x(t,e,r,n){if(l(r))for(var o=0;o<r.length;o++)v(e,r[o])&&t.push(n(r[o]));else for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];s=s&&!0!==s?s.displayText?{text:s.text,displayText:s.displayText}:s.text:i,v(e,s)&&t.push(n(s))}}function m(t){"."==t.charAt(0)&&(t=t.substr(1));for(var e=t.split(o+o),r=0;r<e.length;r++)e[r]=e[r].replace(new RegExp(o,"g"),"");return e.join(o)}function b(t){for(var e=c(t).split("."),r=0;r<e.length;r++)e[r]=o+e[r].replace(new RegExp(o,"g"),o+o)+o;var n=e.join(".");return"string"==typeof t?n:(t=h(t),t.text=n,t)}function y(t,n,i,a){var l=!1,u=[],f=n.start,c=!0;while(c)c="."==n.string.charAt(0),l=l||n.string.charAt(0)==o,f=n.start,u.unshift(m(n.string)),n=a.getTokenAt(s(t.line,n.start)),"."==n.string&&(c=!0,n=a.getTokenAt(s(t.line,n.start)));var p=u.join(".");x(i,p,e,(function(t){return l?b(t):t})),x(i,p,r,(function(t){return l?b(t):t})),p=u.pop();var d=u.join("."),v=!1,y=d;if(!g(d)){var C=d;d=A(d,a),d!==C&&(v=!0)}var q=g(d);return q&&q.columns&&(q=q.columns),q&&x(i,p,q,(function(t){var e=d;return 1==v&&(e=y),"string"==typeof t?t=e+"."+t:(t=h(t),t.text=e+"."+t.text),l?b(t):t})),f}function C(t,e){for(var r=t.split(/\s+/),n=0;n<r.length;n++)r[n]&&e(r[n].replace(/[`,;]/g,""))}function A(t,e){var r=e.doc,n=r.getValue(),o=t.toUpperCase(),l="",u="",f=[],c={start:s(0,0),end:s(e.lastLine(),e.getLineHandle(e.lastLine()).length)},p=n.indexOf(i.QUERY_DIV);while(-1!=p)f.push(r.posFromIndex(p)),p=n.indexOf(i.QUERY_DIV,p+1);f.unshift(s(0,0)),f.push(s(e.lastLine(),e.getLineHandle(e.lastLine()).text.length));for(var d=null,h=e.getCursor(),v=0;v<f.length;v++){if((null==d||a(h,d)>0)&&a(h,f[v])<=0){c={start:d,end:f[v]};break}d=f[v]}if(c.start){var x=r.getRange(c.start,c.end,!1);for(v=0;v<x.length;v++){var m=x[v];if(C(m,(function(t){var e=t.toUpperCase();e===o&&g(l)&&(u=l),e!==i.ALIAS_KEYWORD&&(l=t)})),u)break}}return u}t.registerHelper("hint","sql",(function(t,i){e=d(i&&i.tables);var a=i&&i.defaultTable,l=i&&i.disableKeywords;r=a&&g(a),n=u(t),o=f(t),a&&!r&&(r=A(a,t)),r=r||[],r.columns&&(r=r.columns);var c,p,h,v=t.getCursor(),m=[],b=t.getTokenAt(v);if(b.end>v.ch&&(b.end=v.ch,b.string=b.string.slice(0,v.ch-b.start)),b.string.match(/^[.`"'\w@][\w$#]*$/g)?(h=b.string,c=b.start,p=b.end):(c=p=v.ch,h=""),"."==h.charAt(0)||h.charAt(0)==o)c=y(v,b,m,t);else{var C=function(t,e){return"object"===typeof t?t.className=e:t={text:t,className:e},t};x(m,h,r,(function(t){return C(t,"CodeMirror-hint-table CodeMirror-hint-default-table")})),x(m,h,e,(function(t){return C(t,"CodeMirror-hint-table")})),l||x(m,h,n,(function(t){return C(t.toUpperCase(),"CodeMirror-hint-keyword")}))}return{list:m,from:s(v.line,c),to:s(v.line,p)}}))}));