import{chrome,gecko,ie,mac,presto,safari,webkit}from"../util/browser.js";import{e_preventDefault}from"../util/event.js";import{updateDisplaySimple}from"./update_display.js";import{setScrollLeft,updateScrollTop}from"./scrolling.js";let wheelSamples=0,wheelPixelsPerUnit=null;function wheelEventDelta(e){let l=e.wheelDeltaX,t=e.wheelDeltaY;return null==l&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(l=e.detail),null==t&&e.detail&&e.axis==e.VERTICAL_AXIS?t=e.detail:null==t&&(t=e.wheelDelta),{x:l,y:t}}ie?wheelPixelsPerUnit=-.53:gecko?wheelPixelsPerUnit=15:chrome?wheelPixelsPerUnit=-.7:safari&&(wheelPixelsPerUnit=-1/3);export function wheelEventPixels(e){let l=wheelEventDelta(e);return l.x*=wheelPixelsPerUnit,l.y*=wheelPixelsPerUnit,l}export function onScrollWheel(e,l){let t=wheelEventDelta(l),r=t.x,i=t.y,h=e.display,a=h.scroller,o=a.scrollWidth>a.clientWidth,n=a.scrollHeight>a.clientHeight;if(r&&o||i&&n){if(i&&mac&&webkit)e:for(let t=l.target,r=h.view;t!=a;t=t.parentNode)for(let l=0;l<r.length;l++)if(r[l].node==t){e.display.currentWheelTarget=t;break e}if(r&&!gecko&&!presto&&null!=wheelPixelsPerUnit)return i&&n&&updateScrollTop(e,Math.max(0,a.scrollTop+i*wheelPixelsPerUnit)),setScrollLeft(e,Math.max(0,a.scrollLeft+r*wheelPixelsPerUnit)),(!i||i&&n)&&e_preventDefault(l),void(h.wheelStartX=null);if(i&&null!=wheelPixelsPerUnit){let l=i*wheelPixelsPerUnit,t=e.doc.scrollTop,r=t+h.wrapper.clientHeight;l<0?t=Math.max(0,t+l-50):r=Math.min(e.doc.height,r+l+50),updateDisplaySimple(e,{top:t,bottom:r})}wheelSamples<20&&(null==h.wheelStartX?(h.wheelStartX=a.scrollLeft,h.wheelStartY=a.scrollTop,h.wheelDX=r,h.wheelDY=i,setTimeout((()=>{if(null==h.wheelStartX)return;let e=a.scrollLeft-h.wheelStartX,l=a.scrollTop-h.wheelStartY,t=l&&h.wheelDY&&l/h.wheelDY||e&&h.wheelDX&&e/h.wheelDX;h.wheelStartX=h.wheelStartY=null,t&&(wheelPixelsPerUnit=(wheelPixelsPerUnit*wheelSamples+t)/(wheelSamples+1),++wheelSamples)}),200)):(h.wheelDX+=r,h.wheelDY+=i))}}