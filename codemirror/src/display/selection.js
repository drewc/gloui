import{Pos}from"../line/pos.js";import{visualLine}from"../line/spans.js";import{getLine}from"../line/utils_line.js";import{charCoords,cursorCoords,displayWidth,paddingH,wrappedLineExtentChar}from"../measurement/position_measurement.js";import{getOrder,iterateBidiSections}from"../util/bidi.js";import{elt}from"../util/dom.js";import{onBlur}from"./focus.js";export function updateSelection(t){t.display.input.showSelection(t.display.input.prepareSelection())}export function prepareSelection(t,e=!0){let o=t.doc,i={},r=i.cursors=document.createDocumentFragment(),l=i.selection=document.createDocumentFragment();for(let n=0;n<o.sel.ranges.length;n++){if(!e&&n==o.sel.primIndex)continue;let i=o.sel.ranges[n];if(i.from().line>=t.display.viewTo||i.to().line<t.display.viewFrom)continue;let s=i.empty();(s||t.options.showCursorWhenSelecting)&&drawSelectionCursor(t,i.head,r),s||drawSelectionRange(t,i,l)}return i}export function drawSelectionCursor(t,e,o){let i=cursorCoords(t,e,"div",null,null,!t.options.singleCursorHeightPerLine),r=o.appendChild(elt("div"," ","CodeMirror-cursor"));if(r.style.left=i.left+"px",r.style.top=i.top+"px",r.style.height=Math.max(0,i.bottom-i.top)*t.options.cursorHeight+"px",i.other){let t=o.appendChild(elt("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));t.style.display="",t.style.left=i.other.left+"px",t.style.top=i.other.top+"px",t.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function cmpCoords(t,e){return t.top-e.top||t.left-e.left}function drawSelectionRange(t,e,o){let i=t.display,r=t.doc,l=document.createDocumentFragment(),n=paddingH(t.display),s=n.left,p=Math.max(i.sizerWidth,displayWidth(t)-i.sizer.offsetLeft)-n.right,d="ltr"==r.direction;function u(t,e,o,i){e<0&&(e=0),e=Math.round(e),i=Math.round(i),l.appendChild(elt("div",null,"CodeMirror-selected",`position: absolute; left: ${t}px;\n                             top: ${e}px; width: ${null==o?p-t:o}px;\n                             height: ${i-e}px`))}function a(e,o,i){let l,n,a=getLine(r,e),c=a.text.length;function h(o,i){return charCoords(t,Pos(e,o),"div",a,i)}function f(e,o,i){let r=wrappedLineExtentChar(t,a,null,e),l="ltr"==o==("after"==i)?"left":"right",n="after"==i?r.begin:r.end-(/\s/.test(a.text.charAt(r.end-1))?2:1);return h(n,l)[l]}let m=getOrder(a,r.direction);return iterateBidiSections(m,o||0,null==i?c:i,((t,e,r,a)=>{let g="ltr"==r,y=h(t,g?"left":"right"),C=h(e-1,g?"right":"left"),b=null==o&&0==t,x=null==i&&e==c,v=0==a,w=!m||a==m.length-1;if(C.top-y.top<=3){let t=(d?b:x)&&v,e=(d?x:b)&&w,o=t?s:(g?y:C).left,i=e?p:(g?C:y).right;u(o,y.top,i-o,y.bottom)}else{let o,i,l,n;g?(o=d&&b&&v?s:y.left,i=d?p:f(t,r,"before"),l=d?s:f(e,r,"after"),n=d&&x&&w?p:C.right):(o=d?f(t,r,"before"):s,i=!d&&b&&v?p:y.right,l=!d&&x&&w?s:C.left,n=d?f(e,r,"after"):p),u(o,y.top,i-o,y.bottom),y.bottom<C.top&&u(s,y.bottom,null,C.top),u(l,C.top,n-l,C.bottom)}(!l||cmpCoords(y,l)<0)&&(l=y),cmpCoords(C,l)<0&&(l=C),(!n||cmpCoords(y,n)<0)&&(n=y),cmpCoords(C,n)<0&&(n=C)})),{start:l,end:n}}let c=e.from(),h=e.to();if(c.line==h.line)a(c.line,c.ch,h.ch);else{let t=getLine(r,c.line),e=getLine(r,h.line),o=visualLine(t)==visualLine(e),i=a(c.line,c.ch,o?t.text.length+1:null).end,l=a(h.line,o?0:null,h.ch).start;o&&(i.top<l.top-2?(u(i.right,i.top,null,i.bottom),u(s,l.top,l.left,l.bottom)):u(i.right,i.top,l.left-i.right,i.bottom)),i.bottom<l.top&&u(s,i.bottom,null,l.top)}o.appendChild(l)}export function restartBlink(t){if(!t.state.focused)return;let e=t.display;clearInterval(e.blinker);let o=!0;e.cursorDiv.style.visibility="",t.options.cursorBlinkRate>0?e.blinker=setInterval((()=>{t.hasFocus()||onBlur(t),e.cursorDiv.style.visibility=(o=!o)?"":"hidden"}),t.options.cursorBlinkRate):t.options.cursorBlinkRate<0&&(e.cursorDiv.style.visibility="hidden")}